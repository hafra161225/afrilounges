<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Sales & Stock Summary</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Progress Indicator -->
  <ion-progress-bar
    [value]="getProgress()"
    color="primary">
  </ion-progress-bar>

  <!-- Page Title and Description -->
  <div class="page-header">
    <h2>{{ pageTitles[currentPage - 1] }}</h2>
    <p>{{ pageDescriptions[currentPage - 1] }}</p>
    <p class="page-indicator">Step {{ currentPage }} of {{ totalPages }}</p>
  </div>

  <form [formGroup]="summaryForm" (ngSubmit)="currentPage === totalPages ? onSubmit() : nextPage()">
    <!-- Page 1: Beer Selection -->
    <div *ngIf="currentPage === 1">
      <ion-card>
        <ion-card-header>
          <ion-card-title>Beer Selection</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <!-- Search Input -->
          <ion-item>
            <ion-icon name="search-outline" slot="start"></ion-icon>
            <ion-input
              placeholder="Search beers..."
              (ionInput)="onBeerSearch($event)">
            </ion-input>
          </ion-item>

          <!-- Beer List -->
          <ng-container *ngIf="!isLoadingStock; else beerTemplate">
            <div class="beer-selection-list">
              <ion-card
                *ngFor="let beer of stockData"
                [class.selected]="summaryForm.get('selectedBeerId')?.value === beer.id"
                (click)="selectBeer(beer)"
                class="beer-card">
                <ion-card-content class="beer-card-content">
                  <div class="beer-info">
                    <h3>{{ beer.name }}</h3>
                    <p>{{ beer.type }} • MWK {{ beer.sellingPrice.toLocaleString() }}</p>
                    <p>Outlet: {{ beer.outlet }}</p>
                    <small>Stock: {{ beer.qty }} qty • {{ beer.shots }} shots</small>
                  </div>
                  <ion-icon
                    *ngIf="summaryForm.get('selectedBeerId')?.value === beer.id"
                    name="checkmark-circle"
                    color="success"
                    class="selection-icon">
                  </ion-icon>
                </ion-card-content>
              </ion-card>
            </div>
          </ng-container>

          <ng-template #beerTemplate>
            <div class="beer-selection-list">
              <ion-card
                class="beer-card">
                <ion-card-content class="beer-card-content">
                  <div class="beer-info">
                    <h3>
                      <ion-text-skeleton></ion-text-skeleton>
                    </h3>
                    <p>
                      <ion-text-skeleton></ion-text-skeleton>
                    </p>
                    <small>
                      <ion-text-skeleton></ion-text-skeleton>
                    </small>
                  </div>
                  <ion-icon
                    class="selection-icon">
                      <ion-text-skeleton></ion-text-skeleton>
                  </ion-icon>
                </ion-card-content>
              </ion-card>
            </div>
          </ng-template>

          <!-- Selected Beer Display -->
          <div *ngIf="selectedBeer" class="selected-beer-display">
            <ion-card class="selected-card">
              <ion-card-content>
                <h4>Selected: {{ selectedBeer.name }}</h4>
                <p>Type: {{ selectedBeer.type }}</p>
                <p>Outlet: {{ selectedBeer.outlet }}</p>
                <p>Price: MWK {{ selectedBeer.sellingPrice.toLocaleString() }}</p>
              </ion-card-content>
            </ion-card>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Page 2: Quantity & Shots -->
    <div *ngIf="currentPage === 2">
      <ion-card>
        <ion-card-header>
          <ion-card-title>Quantity & Shots</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <!-- Selected Beer Info -->
          <div *ngIf="selectedBeer" class="beer-summary">
            <ion-card class="summary-card">
              <ion-card-content>
                <h4>{{ selectedBeer.name }}</h4>
                <p>Available: {{ selectedBeer.qty }} qty • {{ selectedBeer.shots }} shots</p>
                <p>Price: MWK {{ selectedBeer.sellingPrice.toLocaleString() }} each</p>
              </ion-card-content>
            </ion-card>
          </div>

          <!-- Quantity Input -->
          <ion-item>
            <ion-label position="floating">Quantity</ion-label>
            <ion-input
              formControlName="quantity"
              type="number"
              [min]="0"
              [max]="getMaxQuantity()"
              placeholder="Enter quantity">
            </ion-input>
          </ion-item>
          <p class="validation-text" *ngIf="summaryForm.get('quantity')?.value > getMaxQuantity()">
            ⚠️ Cannot exceed available stock ({{ getMaxQuantity() }})
          </p>

          <!-- Shots Input -->
          <ion-item>
            <ion-label position="floating">Shots</ion-label>
            <ion-input
              formControlName="shots"
              type="number"
              [min]="0"
              [max]="getMaxShots()"
              placeholder="Enter shots">
            </ion-input>
          </ion-item>
          <p class="validation-text" *ngIf="summaryForm.get('shots')?.value > getMaxShots()">
            ⚠️ Cannot exceed available shots ({{ getMaxShots() }})
          </p>

          <!-- Total Amount Display -->
          <ion-card class="total-card">
            <ion-card-content>
              <div class="total-display">
                <h3>Total Amount</h3>
                <p class="total-amount">MWK {{ summaryForm.get('totalAmount')?.value?.toLocaleString() || '0' }}</p>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Page 3: Payment Method -->
    <div *ngIf="currentPage === 3">
      <ion-card>
        <ion-card-header>
          <ion-card-title>Payment Method</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <!-- Order Summary -->
          <div class="order-summary">
            <ion-card class="summary-card">
              <ion-card-content>
                <h4>Order Summary</h4>
                <p>{{ selectedBeer?.name }} × {{ summaryForm.get('quantity')?.value }}</p>
                <p>Shots: {{ summaryForm.get('shots')?.value }}</p>
                <p class="total-line">Total: MWK {{ summaryForm.get('totalAmount')?.value?.toLocaleString() }}</p>
              </ion-card-content>
            </ion-card>
          </div>

          <!-- Payment Method Selection -->
          <div class="payment-methods">
            <ion-card
              *ngFor="let method of paymentMethods"
              [class.selected]="summaryForm.get('paymentMethod')?.value === method.value"
              (click)="summaryForm.patchValue({ paymentMethod: method.value })"
              class="payment-card">
              <ion-card-content class="payment-card-content">
                <div class="payment-info">
                  <ion-icon [name]="method.icon" class="payment-icon"></ion-icon>
                  <div>
                    <h4>{{ method.label }}</h4>
                    <p>{{ getPaymentDescription(method.value) }}</p>
                  </div>
                </div>
                <ion-icon
                  *ngIf="summaryForm.get('paymentMethod')?.value === method.value"
                  name="checkmark-circle"
                  color="success"
                  class="selection-icon">
                </ion-icon>
              </ion-card-content>
            </ion-card>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Page 4: Checkout -->
    <div *ngIf="currentPage === 4">
      <ion-card>
        <ion-card-header>
          <ion-card-title>Checkout</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <!-- Final Order Summary -->
          <div class="final-summary">
            <ion-card class="summary-card">
              <ion-card-content>
                <h4>Final Order Summary</h4>
                <div class="summary-item">
                  <span>Beer:</span>
                  <strong>{{ selectedBeer?.name }}</strong>
                </div>
                <div class="summary-item">
                  <span>Quantity:</span>
                  <strong>{{ summaryForm.get('quantity')?.value }}</strong>
                </div>
                <div class="summary-item">
                  <span>Shots:</span>
                  <strong>{{ summaryForm.get('shots')?.value }}</strong>
                </div>
                <div class="summary-item">
                  <span>Payment:</span>
                  <strong>{{ getPaymentMethodLabel() }}</strong>
                </div>
                <hr>
                <div class="summary-item total-line">
                  <span>Total Amount:</span>
                  <strong>MWK {{ summaryForm.get('totalAmount')?.value?.toLocaleString() }}</strong>
                </div>
              </ion-card-content>
            </ion-card>
          </div>

          <!-- Additional Details -->

          <ion-item>
            <ion-label position="floating">Customer Name (Optional)</ion-label>
            <ion-input
              formControlName="customerName"
              placeholder="Enter customer name">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="floating">Notes (Optional)</ion-label>
            <ion-input
              formControlName="notes"
              placeholder="Any additional notes">
            </ion-input>
          </ion-item>

          <!-- Confirmation Message -->
          <div class="confirmation-message">
            <ion-icon name="checkmark-circle" color="success"></ion-icon>
            <p>Ready to complete the sale. Click "Generate Report" to process and generate today's report.</p>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Page 5: Authentication -->
    <div *ngIf="currentPage === 5">
      <ion-card>
        <ion-card-header>
          <ion-card-title>Authentication Required</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p class="auth-description">Please enter your credentials to complete the sale and generate the report.</p>

          <ion-item>
            <ion-label position="floating">Username</ion-label>
            <ion-input
              formControlName="userName"
              type="text"
              placeholder="Enter your username"
              required>
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="floating">Password</ion-label>
            <ion-input
              formControlName="password"
              type="password"
              placeholder="Enter your password"
              required>
              <ion-input-password-toggle slot="end"></ion-input-password-toggle>
            </ion-input>
          </ion-item>

          <!-- Sale Summary for Authentication Page -->
          <div class="auth-summary">
            <ion-card class="summary-card">
              <ion-card-content>
                <h4>Sale Summary</h4>
                <div class="summary-item">
                  <span>Beer:</span>
                  <strong>{{ selectedBeer?.name }}</strong>
                </div>
                <div class="summary-item">
                  <span>Quantity:</span>
                  <strong>{{ summaryForm.get('quantity')?.value }}</strong>
                </div>
                <div class="summary-item">
                  <span>Shots:</span>
                  <strong>{{ summaryForm.get('shots')?.value }}</strong>
                </div>
                <div class="summary-item">
                  <span>Payment:</span>
                  <strong>{{ getPaymentMethodLabel() }}</strong>
                </div>
                <hr>
                <div class="summary-item total-line">
                  <span>Total:</span>
                  <strong>MWK {{ summaryForm.get('totalAmount')?.value?.toLocaleString() }}</strong>
                </div>
              </ion-card-content>
            </ion-card>
          </div>

          <!-- Final Confirmation Message -->
          <div class="confirmation-message">
            <ion-icon name="shield-checkmark" color="primary"></ion-icon>
            <p>Your credentials will be verified before completing the sale and generating the report.</p>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Navigation Buttons -->
    <ion-row class="navigation-buttons">
      <ion-col *ngIf="currentPage > 1">
        <ion-button
          expand="block"
          fill="outline"
          (click)="previousPage()"
          class="nav-button">
          <ion-icon slot="start" name="chevron-back"></ion-icon>
          Previous
        </ion-button>
      </ion-col>

      <ion-col [size]="currentPage > 1 ? '6' : '12'">
        <ion-button
          expand="block"
          [disabled]="!canGoNext() || isLoading"
          type="submit"
          class="nav-button primary">
          <ion-spinner *ngIf="isLoading" slot="start" name="crescent"></ion-spinner>
          {{ isLoading ? 'Processing...' : (currentPage === totalPages ? 'Complete Sale' : 'Next') }}
          <ion-icon *ngIf="!isLoading && currentPage < totalPages" slot="end" name="chevron-forward"></ion-icon>
        </ion-button>
      </ion-col>
    </ion-row>
  </form>

  <!-- Floating Action Button -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button [disabled]="isGeneratingReport">
      <ion-icon name="menu"></ion-icon>
    </ion-fab-button>
    <ion-fab-list side="top">
      <ion-fab-button (click)="navigateToLogin()" color="primary" [disabled]="isGeneratingReport">
        <ion-icon name="log-in-outline"></ion-icon>
      </ion-fab-button>
      <ion-fab-button (click)="downloadTodaysReport()" color="success" [disabled]="isGeneratingReport">
        <ion-icon name="download-outline"></ion-icon>
      </ion-fab-button>
      <ion-fab-button (click)="resetForm()" color="danger" [disabled]="isGeneratingReport">
        <ion-icon name="refresh-outline"></ion-icon>
      </ion-fab-button>
    </ion-fab-list>
  </ion-fab>

  <!-- Loading overlay for report generation -->
  <div *ngIf="isGeneratingReport" class="loading-overlay">
    <div class="loading-content">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <h3>Generating Report...</h3>
      <p>Please wait while we process your report</p>
    </div>
  </div>
</ion-content>
